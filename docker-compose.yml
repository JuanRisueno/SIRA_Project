# Este archivo define y ejecuta todos los servicios del proyecto SIRA.

services:

  # 1. Base de Datos: PostgreSQL (sira_db)
  # ----------------------------------------
  db:
    image: postgres:16-alpine      # Imagen ligera, estable y oficial.
    container_name: sira_db        # Nombre de contenedor fijo para conexión y logs.
    restart: unless-stopped        # Reinicia si el contenedor cae (alta disponibilidad básica).
    volumes:
      # Volumen 1: Persistencia de Datos (Volumen Nombrado).
      - postgres_data:/var/lib/postgresql/data/
      
      # Volumen 2: Inicialización Automática de la BBDD (Bind Mount).
      - ./backend/database:/docker-entrypoint-initdb.d 
      
      # Volumen 3: Mapea nuestro archivo de configuración personalizado (para logs).
      - ./config/postgresql.conf:/usr/share/postgresql/postgresql.conf:ro
      
    networks:
      - sira-network               # Conexión a la red interna.
    environment:
      # Variables para crear el usuario principal y la BBDD (leídas del .env).
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      
    # --- MODIFICACIÓN AÑADIDA ---
    # Le decimos a PostgreSQL que inicie usando nuestro archivo de configuración.
    command: postgres -c config_file=/usr/share/postgresql/postgresql.conf

  # 2. API de la Aplicación (Python/FastAPI)
  # -------------------------------------
  api:
    build: ./backend               # Construye la imagen a partir del Dockerfile en la carpeta 'backend'.
    container_name: sira_api
    restart: unless-stopped
    depends_on:
      - db
    volumes:
      # Bind Mount: Sincroniza la carpeta local 'backend' completa con la ruta '/app' del contenedor.
      - ./backend:/app
    networks:
      - sira-network
    environment:
      # URL para que Python sepa cómo conectar a la BBDD.
      - DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@db:5432/${DB_NAME}
      - PYTHONUNBUFFERED=1 # Asegura que los logs de Python se muestren inmediatamente.
      
  # 3. Proxy Inverso (Nginx)
  # ----------------------------------
  nginx:
    image: nginx:latest            # Imagen oficial de Nginx (el estándar industrial).
    container_name: sira_nginx
    restart: unless-stopped
    ports:
      # Mapeo de puertos: El puerto 80 del host al 80 del contenedor.
      - "80:80"
    volumes:
      # Bind Mount 1: Mapea nuestro fichero de configuración (solo lectura).
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Bind Mount 2: Mapeo de LOGS
      - ./logs/nginx:/var/log/nginx
    networks:
      - sira-network
    depends_on:
      - api

# --- Definiciones de Red y Volúmenes ---

# Declara el volumen para la persistencia de la base de datos (Volumen Nombrado).
volumes:
  postgres_data:

# Crea la red interna para que los servicios se comuniquen entre sí por nombre.
networks:
  sira-network:
    driver: bridge
